import { DIGIT_GROUP_UTIL, PRETTY_FLOAT_PARAM_UTIL, NUMBER_UTIL, FLOAT_UTIL, PRETTY_FLOAT_UTIL } from '../../utils';
const getDigitGroupParams = PRETTY_FLOAT_PARAM_UTIL.digitGroup;
const getDecimalParams = PRETTY_FLOAT_PARAM_UTIL.decimal;
const sanitizeNum = NUMBER_UTIL.sanitize;
export class PrettyFloat {
    constructor(subject, decimal, digitGroup) {
        this.initValues(subject, decimal, digitGroup);
    }
    get value() {
        return this._value;
    }
    get pointIndex() {
        return this._pointIndex;
    }
    get forcedDecimals() {
        return (this._decimalParams.isDecimalAllowed && this._hasDecimalPart) ? this._forcedDecimals : 0;
    }
    get trimmedDecimals() {
        return this._decimalParams.isDecimalAllowed ? this._trimmedDecimals : '';
    }
    get hasDecimalPart() {
        return this._hasDecimalPart;
    }
    get digitGroupDelimiters() {
        const delimiters = [];
        if (!this._digitGroupParams?.hasDigitGroups)
            return delimiters;
        if (this._digitGroupParams.integerPart.groupSize > 0)
            delimiters.push(this._digitGroupParams.integerPart.delimiter);
        if (this._digitGroupParams.decimalPart.groupSize > 0)
            delimiters.push(this._digitGroupParams.decimalPart.delimiter);
        return delimiters;
    }
    get isNegative() {
        const number = this.value.number;
        return (number != null) && (number < 0);
    }
    get prettyValue() {
        return this._value.pretty;
    }
    get numberValue() {
        return this._value.number;
    }
    get intPart() {
        const value = Number(this._value.number?.toFixed());
        return Number.isNaN(value) ? null : value;
    }
    get prettyIntPart() {
        const prettyInt = this._value.pretty;
        return (this._pointIndex.prettyIndex > -1) ? prettyInt.substring(0, this._pointIndex.prettyIndex) : prettyInt;
    }
    get decimals() {
        return this._hasDecimalPart ? `${this._value.number}`.substring(this._pointIndex.numberIndex + 1) : '';
    }
    get prettyDecimals() {
        return this._hasDecimalPart ? this._value.pretty.substring(this._pointIndex.prettyIndex + 1) : '';
    }
    get decimalParams() {
        return this._decimalParams;
    }
    get digitGroupParams() {
        return this._digitGroupParams;
    }
    clone() {
        return new PrettyFloat(this.prettyValue, this.decimalParams, this.digitGroupParams);
    }
    updateIntPartDigitGroupParams(params) {
        this._digitGroupParams = getDigitGroupParams(this._digitGroupParams, { integerPart: params });
        return this.updateValue(this.prettyValue);
    }
    updateDecimalsDigitGroupParams(params) {
        this._digitGroupParams = getDigitGroupParams(this._digitGroupParams, { decimalPart: params });
        return this.updateValue(this.prettyValue);
    }
    updateDigitGroupParams(params) {
        this._digitGroupParams = getDigitGroupParams(this._digitGroupParams, params);
        return this.updateValue(this.prettyValue);
    }
    updateDecimalParams(decimal) {
        this._decimalParams = getDecimalParams(decimal);
        return this.updateValue(this.prettyValue);
    }
    updateValue(newValue) {
        this.value = this._decimalParams.isDecimalAllowed
            ? this.getValueWithDecimals(newValue)
            : this.getValueWithoutDecimals(newValue);
        return this;
    }
    set digitGroupParams(digitGroup) {
        this._digitGroupParams = getDigitGroupParams(digitGroup);
    }
    set decimalParams(decimal) {
        this._decimalParams = getDecimalParams(decimal);
    }
    set value(value) {
        this._value = value;
        if (!this._pointIndex)
            this._pointIndex = { prettyIndex: -1, numberIndex: -1 };
        if (!this.decimalParams.isDecimalAllowed)
            return;
        this.updateFloatPointIndices();
    }
    updateFloatPointIndices() {
        this.updateNumberValuePointIndex();
        this.updatePrettyValuePointIndex();
    }
    updateNumberValuePointIndex() {
        this._pointIndex.numberIndex = `${this.numberValue ?? ''}`.indexOf('.');
    }
    updatePrettyValuePointIndex() {
        this._pointIndex.prettyIndex = this.prettyValue.indexOf(this.decimalParams.floatPoint);
    }
    initValues(subject, decimal, digitGroup) {
        this.setParams(decimal, digitGroup);
        this.value = this._decimalParams?.isDecimalAllowed
            ? this.getValueWithDecimals(subject)
            : this.getValueWithoutDecimals(subject);
    }
    setParams(decimal, digitGroup) {
        this.decimalParams = decimal;
        this.digitGroupParams = digitGroup;
        this._hasDecimalPart = false;
    }
    getValueWithoutDecimals(subject) {
        let value = sanitizeNum(subject);
        while (value[0] === '0')
            value = value.substring(1);
        if (!value)
            return { pretty: '', number: null };
        const params = this._digitGroupParams;
        return {
            number: parseInt(value, 10),
            pretty: params.hasDigitGroups ? DIGIT_GROUP_UTIL.apply(value, params.integerPart) : value
        };
    }
    getValueWithDecimals(subject) {
        this.resetDecimalPartParams();
        const floatPoint = this._decimalParams.floatPoint;
        const value = FLOAT_UTIL.sanitize(subject, floatPoint);
        const intPart = FLOAT_UTIL.getIntPart(value, floatPoint, true);
        if (!value || !intPart)
            return { pretty: '', number: null };
        const decimals = this.getDecimals(value);
        return {
            number: parseFloat(`${intPart}.${decimals}`),
            pretty: PRETTY_FLOAT_UTIL.sanitize(`${intPart}${(decimals.length || (value[value.length - 1] === floatPoint)) ? floatPoint : ''}${decimals}`, floatPoint, this._digitGroupParams, true)
        };
    }
    resetDecimalPartParams() {
        this._forcedDecimals = 0;
        this._trimmedDecimals = '';
    }
    getDecimals(value) {
        const params = this._decimalParams;
        let decimal = FLOAT_UTIL.getDecimals(value, params.floatPoint, true);
        if (params.minDigitCount > 0)
            decimal = this.appendZeroDecimals(decimal);
        if (params.maxDigitCount > -1)
            decimal = this.trimRedundantDecimals(decimal);
        this._hasDecimalPart = !!decimal;
        return decimal;
    }
    appendZeroDecimals(decimalPart) {
        let decimal = decimalPart;
        while (decimal.length < this._decimalParams.minDigitCount) {
            decimal += '0';
            this._forcedDecimals++;
        }
        return decimal;
    }
    trimRedundantDecimals(decimalPart) {
        let decimal = decimalPart;
        while (decimal.length > this._decimalParams.maxDigitCount) {
            const lastIndex = decimal.length - 1;
            const lastDigit = decimal[lastIndex];
            if ((lastDigit === '0') && (this._forcedDecimals > 0))
                this._forcedDecimals--;
            else
                this._trimmedDecimals = `${lastDigit}${this._trimmedDecimals}`;
            decimal = decimal.substring(0, lastIndex);
        }
        return decimal;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJldHR5LWZsb2F0LmNsYXNzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctaW5kaWdpdC9zcmMvbGliL2NsYXNzZXMvUHJldHR5RmxvYXQvcHJldHR5LWZsb2F0LmNsYXNzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSx1QkFBdUIsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLGlCQUFpQixFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3BILE1BQU0sbUJBQW1CLEdBQUcsdUJBQXVCLENBQUMsVUFBVSxDQUFDO0FBQy9ELE1BQU0sZ0JBQWdCLEdBQUcsdUJBQXVCLENBQUMsT0FBTyxDQUFDO0FBQ3pELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUM7QUFFekMsTUFBTSxPQUFPLFdBQVc7SUFVdEIsWUFBWSxPQUFlLEVBQUUsT0FBYSxFQUFFLFVBQWdCO1FBQzFELElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxVQUFVLENBQUMsQ0FBQztJQUNoRCxDQUFDO0lBRUQsSUFBSSxLQUFLO1FBQ1AsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxJQUFJLFVBQVU7UUFDWixPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7SUFDMUIsQ0FBQztJQUVELElBQUksY0FBYztRQUNoQixPQUFPLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsSUFBSSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRyxDQUFDO0lBRUQsSUFBSSxlQUFlO1FBQ2pCLE9BQU8sSUFBSSxDQUFDLGNBQWMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxFQUFFLENB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aW1wb3J0IHsgSVByZXR0eUZsb2F0RGVjaW1hbFBhcmFtLCBJUHJldHR5RmxvYXREaWdpdEdyb3VwUGFyYW0sIElQcmV0dHlGbG9hdFBvaW50SW5kZXgsIElQcmV0dHlGbG9hdFZhbHVlIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBESUdJVF9HUk9VUF9VVElMLCBQUkVUVFlfRkxPQVRfUEFSQU1fVVRJTCwgTlVNQkVSX1VUSUwsIEZMT0FUX1VUSUwsIFBSRVRUWV9GTE9BVF9VVElMIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgVEN1c3RvbUNoYXJhY3RlciwgVElucHV0IH0gZnJvbSAnLi4vLi4vdHlwZXMnO1xuXG5jb25zdCBnZXREaWdpdEdyb3VwUGFyYW1zID0gUFJFVFRZX0ZMT0FUX1BBUkFNX1VUSUwuZGlnaXRHcm91cDtcbmNvbnN0IGdldERlY2ltYWxQYXJhbXMgPSBQUkVUVFlfRkxPQVRfUEFSQU1fVVRJTC5kZWNpbWFsO1xuY29uc3Qgc2FuaXRpemVOdW0gPSBOVU1CRVJfVVRJTC5zYW5pdGl6ZTtcblxuZXhwb3J0IGNsYXNzIFByZXR0eUZsb2F0IHtcblxuICBwcml2YXRlIF92YWx1ZSE6IElQcmV0dHlGbG9hdFZhbHVlO1xuICBwcml2YXRlIF9wb2ludEluZGV4ITogSVByZXR0eUZsb2F0UG9pbnRJbmRleDtcbiAgcHJpdmF0ZSBfaGFzRGVjaW1hbFBhcnQhOiBib29sZWFuO1xuICBwcml2YXRlIF9mb3JjZWREZWNpbWFscyE6IG51bWJlcjtcbiAgcHJpdmF0ZSBfdHJpbW1lZERlY2ltYWxzITogc3RyaW5nO1xuICBwcml2YXRlIF9kZWNpbWFsUGFyYW1zITogSVByZXR0eUZsb2F0RGVjaW1hbFBhcmFtO1xuICBwcml2YXRlIF9kaWdpdEdyb3VwUGFyYW1zITogSVByZXR0eUZsb2F0RGlnaXRHcm91cFBhcmFtO1xuXG4gIGNvbnN0cnVjdG9yKHN1YmplY3Q6IFRJbnB1dCwgZGVjaW1hbD86IGFueSwgZGlnaXRHcm91cD86IGFueSkge1xuICAgIHRoaXMuaW5pdFZhbHVlcyhzdWJqZWN0LCBkZWNpbWFsLCBkaWdpdEdyb3VwKTtcbiAgfVxuXG4gIGdldCB2YWx1ZSgpOiBJUHJldHR5RmxvYXRWYWx1ZSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlO1xuICB9XG5cbiAgZ2V0IHBvaW50SW5kZXgoKTogSVByZXR0eUZsb2F0UG9pbnRJbmRleCB7XG4gICAgcmV0dXJuIHRoaXMuX3BvaW50SW5kZXg7XG4gIH1cblxuICBnZXQgZm9yY2VkRGVjaW1hbHMoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gKHRoaXMuX2RlY2ltYWxQYXJhbXMuaXNEZWNpbWFsQWxsb3dlZCAmJiB0aGlzLl9oYXNEZWNpbWFsUGFydCkgPyB0aGlzLl9mb3JjZWREZWNpbWFscyA6IDA7XG4gIH1cblxuICBnZXQgdHJpbW1lZERlY2ltYWxzKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2RlY2ltYWxQYXJhbXMuaXNEZWNpbWFsQWxsb3dlZCA/IHRoaXMuX3RyaW1tZWREZWNpbWFscyA6ICcnO1xuICB9XG5cbiAgZ2V0IGhhc0RlY2ltYWxQYXJ0KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9oYXNEZWNpbWFsUGFydDtcbiAgfVxuXG4gIGdldCBkaWdpdEdyb3VwRGVsaW1pdGVycygpOiBUQ3VzdG9tQ2hhcmFjdGVyW10ge1xuICAgIGNvbnN0IGRlbGltaXRlcnM6IFRDdXN0b21DaGFyYWN0ZXJbXSA9IFtdO1xuICAgIGlmICghdGhpcy5fZGlnaXRHcm91cFBhcmFtcz8uaGFzRGlnaXRHcm91cHMpXG4gICAgICByZXR1cm4gZGVsaW1pdGVycztcbiAgICBpZiAodGhpcy5fZGlnaXRHcm91cFBhcmFtcy5pbnRlZ2VyUGFydC5ncm91cFNpemUgPiAwKVxuICAgICAgZGVsaW1pdGVycy5wdXNoKHRoaXMuX2RpZ2l0R3JvdXBQYXJhbXMuaW50ZWdlclBhcnQuZGVsaW1pdGVyKTtcbiAgICBpZiAodGhpcy5fZGlnaXRHcm91cFBhcmFtcy5kZWNpbWFsUGFydC5ncm91cFNpemUgPiAwKVxuICAgICAgZGVsaW1pdGVycy5wdXNoKHRoaXMuX2RpZ2l0R3JvdXBQYXJhbXMuZGVjaW1hbFBhcnQuZGVsaW1pdGVyKTtcbiAgICByZXR1cm4gZGVsaW1pdGVycztcbiAgfVxuXG4gIGdldCBpc05lZ2F0aXZlKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG51bWJlciA9IHRoaXMudmFsdWUubnVtYmVyO1xuICAgIHJldHVybiAobnVtYmVyICE9IG51bGwpICYmIChudW1iZXIgPCAwKTtcbiAgfVxuXG4gIGdldCBwcmV0dHlWYWx1ZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl92YWx1ZS5wcmV0dHk7XG4gIH1cblxuICBnZXQgbnVtYmVyVmFsdWUoKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlLm51bWJlcjtcbiAgfVxuXG4gIGdldCBpbnRQYXJ0KCk6IG51bWJlciB8IG51bGwge1xuICAgIGNvbnN0IHZhbHVlID0gTnVtYmVyKHRoaXMuX3ZhbHVlLm51bWJlcj8udG9GaXhlZCgpKTtcbiAgICByZXR1cm4gTnVtYmVyLmlzTmFOKHZhbHVlKSA/IG51bGwgOiB2YWx1ZTtcbiAgfVxuXG4gIGdldCBwcmV0dHlJbnRQYXJ0KCk6IHN0cmluZyB7XG4gICAgY29uc3QgcHJldHR5SW50ID0gdGhpcy5fdmFsdWUucHJldHR5O1xuICAgIHJldHVybiAodGhpcy5fcG9pbnRJbmRleC5wcmV0dHlJbmRleCA+IC0xKSA/IHByZXR0eUludC5zdWJzdHJpbmcoMCwgdGhpcy5fcG9pbnRJbmRleC5wcmV0dHlJbmRleCkgOiBwcmV0dHlJbnQ7XG4gIH1cblxuICBnZXQgZGVjaW1hbHMoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5faGFzRGVjaW1hbFBhcnQgPyBgJHt0aGlzLl92YWx1ZS5udW1iZXJ9YC5zdWJzdHJpbmcodGhpcy5fcG9pbnRJbmRleC5udW1iZXJJbmRleCArIDEpIDogJyc7XG4gIH1cblxuICBnZXQgcHJldHR5RGVjaW1hbHMoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5faGFzRGVjaW1hbFBhcnQgPyB0aGlzLl92YWx1ZS5wcmV0dHkuc3Vic3RyaW5nKHRoaXMuX3BvaW50SW5kZXgucHJldHR5SW5kZXggKyAxKSA6ICcnO1xuICB9XG5cbiAgZ2V0IGRlY2ltYWxQYXJhbXMoKTogSVByZXR0eUZsb2F0RGVjaW1hbFBhcmFtIHtcbiAgICByZXR1cm4gdGhpcy5fZGVjaW1hbFBhcmFtcztcbiAgfVxuXG4gIGdldCBkaWdpdEdyb3VwUGFyYW1zKCk6IElQcmV0dHlGbG9hdERpZ2l0R3JvdXBQYXJhbSB7XG4gICAgcmV0dXJuIHRoaXMuX2RpZ2l0R3JvdXBQYXJhbXM7XG4gIH1cblxuICBjbG9uZSgpOiBQcmV0dHlGbG9hdCB7XG4gICAgcmV0dXJuIG5ldyBQcmV0dHlGbG9hdCh0aGlzLnByZXR0eVZhbHVlLCB0aGlzLmRlY2ltYWxQYXJhbXMsIHRoaXMuZGlnaXRHcm91cFBhcmFtcyk7XG4gIH1cblxuICB1cGRhdGVJbnRQYXJ0RGlnaXRHcm91cFBhcmFtcyhwYXJhbXM6IGFueSk6IFByZXR0eUZsb2F0IHtcbiAgICB0aGlzLl9kaWdpdEdyb3VwUGFyYW1zID0gZ2V0RGlnaXRHcm91cFBhcmFtcyh0aGlzLl9kaWdpdEdyb3VwUGFyYW1zLCB7IGludGVnZXJQYXJ0OiBwYXJhbXMgfSk7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlVmFsdWUodGhpcy5wcmV0dHlWYWx1ZSk7XG4gIH1cblxuICB1cGRhdGVEZWNpbWFsc0RpZ2l0R3JvdXBQYXJhbXMocGFyYW1zOiBhbnkpOiBQcmV0dHlGbG9hdCB7XG4gICAgdGhpcy5fZGlnaXRHcm91cFBhcmFtcyA9IGdldERpZ2l0R3JvdXBQYXJhbXModGhpcy5fZGlnaXRHcm91cFBhcmFtcywgeyBkZWNpbWFsUGFydDogcGFyYW1zIH0pO1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVZhbHVlKHRoaXMucHJldHR5VmFsdWUpO1xuICB9XG5cbiAgdXBkYXRlRGlnaXRHcm91cFBhcmFtcyhwYXJhbXM6IGFueSk6IFByZXR0eUZsb2F0IHtcbiAgICB0aGlzLl9kaWdpdEdyb3VwUGFyYW1zID0gZ2V0RGlnaXRHcm91cFBhcmFtcyh0aGlzLl9kaWdpdEdyb3VwUGFyYW1zLCBwYXJhbXMpO1xuICAgIHJldHVybiB0aGlzLnVwZGF0ZVZhbHVlKHRoaXMucHJldHR5VmFsdWUpO1xuICB9XG5cbiAgdXBkYXRlRGVjaW1hbFBhcmFtcyhkZWNpbWFsOiBhbnkpOiBQcmV0dHlGbG9hdCB7XG4gICAgdGhpcy5fZGVjaW1hbFBhcmFtcyA9IGdldERlY2ltYWxQYXJhbXMoZGVjaW1hbCk7XG4gICAgcmV0dXJuIHRoaXMudXBkYXRlVmFsdWUodGhpcy5wcmV0dHlWYWx1ZSk7XG4gIH1cblxuICB1cGRhdGVWYWx1ZShuZXdWYWx1ZTogVElucHV0KTogUHJldHR5RmxvYXQge1xuICAgIHRoaXMudmFsdWUgPSB0aGlzLl9kZWNpbWFsUGFyYW1zLmlzRGVjaW1hbEFsbG93ZWRcbiAgICAgID8gdGhpcy5nZXRWYWx1ZVdpdGhEZWNpbWFscyhuZXdWYWx1ZSlcbiAgICAgIDogdGhpcy5nZXRWYWx1ZVdpdGhvdXREZWNpbWFscyhuZXdWYWx1ZSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwcml2YXRlIHNldCBkaWdpdEdyb3VwUGFyYW1zKGRpZ2l0R3JvdXA6IGFueSkge1xuICAgIHRoaXMuX2RpZ2l0R3JvdXBQYXJhbXMgPSBnZXREaWdpdEdyb3VwUGFyYW1zKGRpZ2l0R3JvdXApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXQgZGVjaW1hbFBhcmFtcyhkZWNpbWFsOiBhbnkpIHtcbiAgICB0aGlzLl9kZWNpbWFsUGFyYW1zID0gZ2V0RGVjaW1hbFBhcmFtcyhkZWNpbWFsKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0IHZhbHVlKHZhbHVlOiBJUHJldHR5RmxvYXRWYWx1ZSkge1xuICAgIHRoaXMuX3ZhbHVlID0gdmFsdWU7XG4gICAgaWYgKCF0aGlzLl9wb2ludEluZGV4KVxuICAgICAgdGhpcy5fcG9pbnRJbmRleCA9IHsgcHJldHR5SW5kZXg6IC0xLCBudW1iZXJJbmRleDogLTEgfTtcbiAgICBpZiAoIXRoaXMuZGVjaW1hbFBhcmFtcy5pc0RlY2ltYWxBbGxvd2VkKVxuICAgICAgcmV0dXJuO1xuICAgIHRoaXMudXBkYXRlRmxvYXRQb2ludEluZGljZXMoKTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlRmxvYXRQb2ludEluZGljZXMoKTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVOdW1iZXJWYWx1ZVBvaW50SW5kZXgoKTtcbiAgICB0aGlzLnVwZGF0ZVByZXR0eVZhbHVlUG9pbnRJbmRleCgpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVOdW1iZXJWYWx1ZVBvaW50SW5kZXgoKTogdm9pZCB7XG4gICAgdGhpcy5fcG9pbnRJbmRleC5udW1iZXJJbmRleCA9IGAke3RoaXMubnVtYmVyVmFsdWUgPz8gJyd9YC5pbmRleE9mKCcuJyk7XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVByZXR0eVZhbHVlUG9pbnRJbmRleCgpOiB2b2lkIHtcbiAgICB0aGlzLl9wb2ludEluZGV4LnByZXR0eUluZGV4ID0gdGhpcy5wcmV0dHlWYWx1ZS5pbmRleE9mKHRoaXMuZGVjaW1hbFBhcmFtcy5mbG9hdFBvaW50KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFZhbHVlcyhzdWJqZWN0OiBUSW5wdXQsIGRlY2ltYWw/OiBhbnksIGRpZ2l0R3JvdXA/OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLnNldFBhcmFtcyhkZWNpbWFsLCBkaWdpdEdyb3VwKTtcbiAgICB0aGlzLnZhbHVlID0gdGhpcy5fZGVjaW1hbFBhcmFtcz8uaXNEZWNpbWFsQWxsb3dlZFxuICAgICAgPyB0aGlzLmdldFZhbHVlV2l0aERlY2ltYWxzKHN1YmplY3QpXG4gICAgICA6IHRoaXMuZ2V0VmFsdWVXaXRob3V0RGVjaW1hbHMoc3ViamVjdCk7XG4gIH1cblxuICBwcml2YXRlIHNldFBhcmFtcyhkZWNpbWFsPzogYW55LCBkaWdpdEdyb3VwPzogYW55KSB7XG4gICAgdGhpcy5kZWNpbWFsUGFyYW1zID0gZGVjaW1hbDtcbiAgICB0aGlzLmRpZ2l0R3JvdXBQYXJhbXMgPSBkaWdpdEdyb3VwO1xuICAgIHRoaXMuX2hhc0RlY2ltYWxQYXJ0ID0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGdldFZhbHVlV2l0aG91dERlY2ltYWxzKHN1YmplY3Q6IFRJbnB1dCk6IElQcmV0dHlGbG9hdFZhbHVlIHtcbiAgICBsZXQgdmFsdWUgPSBzYW5pdGl6ZU51bShzdWJqZWN0KTtcbiAgICB3aGlsZSAodmFsdWVbMF0gPT09ICcwJylcbiAgICAgIHZhbHVlID0gdmFsdWUuc3Vic3RyaW5nKDEpO1xuICAgIGlmICghdmFsdWUpXG4gICAgICByZXR1cm4geyBwcmV0dHk6ICcnLCBudW1iZXI6IG51bGwgfTtcbiAgICBjb25zdCBwYXJhbXMgPSB0aGlzLl9kaWdpdEdyb3VwUGFyYW1zO1xuICAgIHJldHVybiB7XG4gICAgICBudW1iZXI6IHBhcnNlSW50KHZhbHVlLCAxMCksXG4gICAgICBwcmV0dHk6IHBhcmFtcy5oYXNEaWdpdEdyb3VwcyA/IERJR0lUX0dST1VQX1VUSUwuYXBwbHkodmFsdWUsIHBhcmFtcy5pbnRlZ2VyUGFydCkgOiB2YWx1ZVxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGdldFZhbHVlV2l0aERlY2ltYWxzKHN1YmplY3Q6IFRJbnB1dCk6IElQcmV0dHlGbG9hdFZhbHVlIHtcbiAgICB0aGlzLnJlc2V0RGVjaW1hbFBhcnRQYXJhbXMoKTtcbiAgICBjb25zdCBmbG9hdFBvaW50ID0gdGhpcy5fZGVjaW1hbFBhcmFtcy5mbG9hdFBvaW50O1xuICAgIGNvbnN0IHZhbHVlID0gRkxPQVRfVVRJTC5zYW5pdGl6ZShzdWJqZWN0LCBmbG9hdFBvaW50KTtcbiAgICBjb25zdCBpbnRQYXJ0ID0gRkxPQVRfVVRJTC5nZXRJbnRQYXJ0KHZhbHVlLCBmbG9hdFBvaW50LCB0cnVlKTtcbiAgICBpZiAoIXZhbHVlIHx8ICFpbnRQYXJ0KVxuICAgICAgcmV0dXJuIHsgcHJldHR5OiAnJywgbnVtYmVyOiBudWxsIH07XG4gICAgY29uc3QgZGVjaW1hbHMgPSB0aGlzLmdldERlY2ltYWxzKHZhbHVlKTtcbiAgICByZXR1cm4ge1xuICAgICAgbnVtYmVyOiBwYXJzZUZsb2F0KGAke2ludFBhcnR9LiR7ZGVjaW1hbHN9YCksXG4gICAgICBwcmV0dHk6IFBSRVRUWV9GTE9BVF9VVElMLnNhbml0aXplKGAke2ludFBhcnR9JHsoZGVjaW1hbHMubGVuZ3RoIHx8ICh2YWx1ZVt2YWx1ZS5sZW5ndGggLSAxXSA9PT0gZmxvYXRQb2ludCkpID8gZmxvYXRQb2ludCA6ICcnfSR7ZGVjaW1hbHN9YFxuICAgICAgICAsIGZsb2F0UG9pbnQsIHRoaXMuX2RpZ2l0R3JvdXBQYXJhbXMsIHRydWUpXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzZXREZWNpbWFsUGFydFBhcmFtcygpOiB2b2lkIHtcbiAgICB0aGlzLl9mb3JjZWREZWNpbWFscyA9IDA7XG4gICAgdGhpcy5fdHJpbW1lZERlY2ltYWxzID0gJyc7XG4gIH1cblxuICBwcml2YXRlIGdldERlY2ltYWxzKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhcmFtcyA9IHRoaXMuX2RlY2ltYWxQYXJhbXM7XG4gICAgbGV0IGRlY2ltYWwgPSBGTE9BVF9VVElMLmdldERlY2ltYWxzKHZhbHVlLCBwYXJhbXMuZmxvYXRQb2ludCwgdHJ1ZSk7XG4gICAgaWYgKHBhcmFtcy5taW5EaWdpdENvdW50ID4gMClcbiAgICAgIGRlY2ltYWwgPSB0aGlzLmFwcGVuZFplcm9EZWNpbWFscyhkZWNpbWFsKTtcbiAgICBpZiAocGFyYW1zLm1heERpZ2l0Q291bnQgPiAtMSlcbiAgICAgIGRlY2ltYWwgPSB0aGlzLnRyaW1SZWR1bmRhbnREZWNpbWFscyhkZWNpbWFsKTtcbiAgICB0aGlzLl9oYXNEZWNpbWFsUGFydCA9ICEhZGVjaW1hbDtcbiAgICByZXR1cm4gZGVjaW1hbDtcbiAgfVxuXG4gIHByaXZhdGUgYXBwZW5kWmVyb0RlY2ltYWxzKGRlY2ltYWxQYXJ0OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBkZWNpbWFsID0gZGVjaW1hbFBhcnQ7XG4gICAgd2hpbGUgKGRlY2ltYWwubGVuZ3RoIDwgdGhpcy5fZGVjaW1hbFBhcmFtcy5taW5EaWdpdENvdW50KSB7XG4gICAgICBkZWNpbWFsICs9ICcwJztcbiAgICAgIHRoaXMuX2ZvcmNlZERlY2ltYWxzKys7XG4gICAgfVxuICAgIHJldHVybiBkZWNpbWFsO1xuICB9XG5cbiAgcHJpdmF0ZSB0cmltUmVkdW5kYW50RGVjaW1hbHMoZGVjaW1hbFBhcnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgbGV0IGRlY2ltYWwgPSBkZWNpbWFsUGFydDtcbiAgICB3aGlsZSAoZGVjaW1hbC5sZW5ndGggPiB0aGlzLl9kZWNpbWFsUGFyYW1zLm1heERpZ2l0Q291bnQpIHtcbiAgICAgIGNvbnN0IGxhc3RJbmRleCA9IGRlY2ltYWwubGVuZ3RoIC0gMTtcbiAgICAgIGNvbnN0IGxhc3REaWdpdCA9IGRlY2ltYWxbbGFzdEluZGV4XTtcbiAgICAgIGlmICgobGFzdERpZ2l0ID09PSAnMCcpICYmICh0aGlzLl9mb3JjZWREZWNpbWFscyA+IDApKVxuICAgICAgICB0aGlzLl9mb3JjZWREZWNpbWFscy0tO1xuICAgICAgZWxzZVxuICAgICAgICB0aGlzLl90cmltbWVkRGVjaW1hbHMgPSBgJHtsYXN0RGlnaXR9JHt0aGlzLl90cmltbWVkRGVjaW1hbHN9YDtcbiAgICAgIGRlY2ltYWwgPSBkZWNpbWFsLnN1YnN0cmluZygwLCBsYXN0SW5kZXgpO1xuICAgIH1cbiAgICByZXR1cm4gZGVjaW1hbDtcbiAgfVxuXG59XG4iXX0=